<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absor√ß√£o de Nutrientes - Soja</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
        }

        /* Header Section */
        .header {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo-placeholder,
        .qr-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .logo-placeholder {
            padding: 10px;
        }

        .logo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .qr-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-info {
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header .subtitle {
            font-size: 20px;
            color: #007AFF;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header .description {
            font-size: 15px;
            color: #86868b;
            font-weight: 400;
        }

        /* Controls Section */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 35px;
        }

        .control-row {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .control-row label {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            min-width: 160px;
            padding-top: 12px;
            white-space: nowrap;
        }

        .select-wrapper {
            flex: 1;
            position: relative;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tag .remove {
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .tag .remove:hover {
            opacity: 1;
        }

        .select-trigger {
            width: 100%;
            padding: 14px 18px;
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            font-size: 15px;
        }

        .select-trigger:hover {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.02);
        }

        .select-trigger.active {
            border-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .select-trigger .placeholder {
            color: #86868b;
        }

        .select-trigger .arrow {
            font-size: 12px;
            color: #86868b;
            transition: transform 0.3s ease;
        }

        .select-trigger.active .arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .select-dropdown.active {
            max-height: 350px;
            opacity: 1;
            overflow-y: auto;
        }

        .select-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .select-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }

        .select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .option {
            padding: 14px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s ease;
        }

        .option:hover {
            background: rgba(0, 122, 255, 0.06);
        }

        .option input[type="checkbox"],
        .option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #007AFF;
        }

        .option label {
            cursor: pointer;
            font-size: 15px;
            color: #1d1d1f;
            flex: 1;
            margin: 0;
        }

        /* Chart Section */
        .chart-section {
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-header h2 {
            font-size: 22px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .chart-header p {
            font-size: 14px;
            color: #86868b;
        }

        canvas {
            border-radius: 16px;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #007AFF;
            border-radius: 16px;
            padding: 20px;
        }

        .info-box h3 {
            font-size: 17px;
            font-weight: 600;
            color: #007AFF;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box p {
            font-size: 15px;
            color: #1d1d1f;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }

            .header-top {
                flex-direction: column;
                gap: 15px;
            }

            .logo-placeholder,
            .qr-placeholder {
                width: 90px;
                height: 90px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header .subtitle {
                font-size: 18px;
            }

            .control-row {
                flex-direction: column;
                gap: 10px;
            }

            .control-row label {
                min-width: auto;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="logo-placeholder">
                    <img src="logo.png" alt="Logo">
                </div>
                <div class="header-info">
                    <h1>Raudinei Afonso</h1>
                </div>
                <div class="qr-placeholder">
                    <img src="qrcode.png" alt="QR Code">
                </div>
            </div>
            <div class="subtitle">Absor√ß√£o de Nutrientes - Soja</div>
            <p class="description">Marcha de absor√ß√£o acumulada (%)</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <!-- Nutrientes -->
            <div class="control-row">
                <label>Nutrientes</label>
                <div class="select-wrapper">
                    <div class="select-trigger" id="nutrientTrigger">
                        <span class="placeholder">Selecione os nutrientes</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="nutrientDropdown">
                        <div class="option">
                            <input type="checkbox" id="n" value="N" checked>
                            <label for="n">Nitrog√™nio (N)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="p" value="P">
                            <label for="p">F√≥sforo (P)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="k" value="K" checked>
                            <label for="k">Pot√°ssio (K)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="ca" value="Ca">
                            <label for="ca">C√°lcio (Ca)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="mg" value="Mg">
                            <label for="mg">Magn√©sio (Mg)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="s" value="S">
                            <label for="s">Enxofre (S)</label>
                        </div>
                        <div style="height: 1px; background: rgba(0,0,0,0.1); margin: 8px 0;"></div>
                        <div class="option">
                            <input type="checkbox" id="b" value="B">
                            <label for="b">Boro (B)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="cu" value="Cu">
                            <label for="cu">Cobre (Cu)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="fe" value="Fe">
                            <label for="fe">Ferro (Fe)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="mn" value="Mn">
                            <label for="mn">Mangan√™s (Mn)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="zn" value="Zn">
                            <label for="zn">Zinco (Zn)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="mo" value="Mo">
                            <label for="mo">Molibd√™nio (Mo)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="co" value="Co">
                            <label for="co">Cobalto (Co)</label>
                        </div>
                        <div class="option">
                            <input type="checkbox" id="ni" value="Ni">
                            <label for="ni">N√≠quel (Ni)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Material Gen√©tico -->
            <div class="control-row">
                <label>Material Gen√©tico</label>
                <div class="select-wrapper">
                    <div class="select-trigger" id="materialTrigger">
                        <span class="placeholder">Selecione o material</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="materialDropdown">
                        <div class="option">
                            <input type="radio" name="material" id="enlist" value="enlist" checked>
                            <label for="enlist">Enlist</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="material" id="xtend" value="xtend">
                            <label for="xtend">Xtend</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="material" id="rr" value="rr">
                            <label for="rr">RR</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 id="chartTitle">Curva de Absor√ß√£o</h2>
                <p>Distribui√ß√£o percentual ao longo dos est√°gios fenol√≥gicos</p>
            </div>
            <canvas id="chart"></canvas>
        </div>

        <!-- Info -->
        <div class="info-box">
            <h3>
                <span>üìä</span>
                Interpreta√ß√£o dos Dados
            </h3>
            <p>
                O gr√°fico apresenta a marcha de absor√ß√£o acumulada de macronutrientes (N, P, K, Ca, Mg, S) e 
                micronutrientes (B, Cu, Fe, Mn, Zn, Mo, Co, Ni) durante o ciclo da cultura da soja. 
                Selecione m√∫ltiplos nutrientes para comparar suas curvas de absor√ß√£o ao longo dos diferentes est√°gios 
                fenol√≥gicos, desde a emerg√™ncia (VE) at√© a matura√ß√£o fisiol√≥gica (R7). Os micronutrientes Co, Mo e Ni 
                s√£o especialmente importantes para a fixa√ß√£o biol√≥gica de nitrog√™nio (FBN).
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==================== CUSTOM LEGEND PLUGIN ====================
        const customLegendPlugin = {
            id: 'customLegend',
            afterDraw: (chart) => {
                const ctx = chart.ctx;
                const legend = chart.legend;
                
                if (!legend || !legend.legendItems || chart.data.datasets.length === 0) return;
                
                // Configuration
                const startX = chart.chartArea.left + 10;
                const startY = chart.chartArea.top - 50;
                const tagHeight = 36;
                const tagPadding = 8;
                const gapBetweenTags = 8;
                const maxWidth = chart.chartArea.width - 20;
                
                let currentX = startX;
                let currentY = startY;
                let rowHeight = 0;
                
                chart.customLegendAreas = [];
                
                chart.data.datasets.forEach((dataset, index) => {
                    const nutrientCode = dataset.nutrientCode;
                    if (!nutrientCode) return;
                    
                    const color = NUTRIENTS[nutrientCode].color;
                    const text = nutrientCode; // Use short code instead of full name
                    
                    // Measure text to calculate tag width
                    ctx.font = '700 15px -apple-system, BlinkMacSystemFont, sans-serif';
                    const textWidth = ctx.measureText(text).width;
                    const xWidth = ctx.measureText('√ó').width;
                    const tagWidth = textWidth + xWidth + tagPadding * 4 + 5;
                    
                    // Check if tag fits in current row, if not move to next row
                    if (currentX + tagWidth > startX + maxWidth && currentX > startX) {
                        currentX = startX;
                        currentY += rowHeight + gapBetweenTags;
                        rowHeight = 0;
                    }
                    
                    // Draw tag background with shadow
                    ctx.save();
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 2;
                    
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.roundRect(currentX, currentY, tagWidth, tagHeight, 18);
                    ctx.fill();
                    ctx.restore();
                    
                    // Draw text
                    ctx.fillStyle = 'white';
                    ctx.font = '700 15px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, currentX + tagPadding + 6, currentY + tagHeight / 2);
                    
                    // Draw X button
                    ctx.font = '700 20px -apple-system, BlinkMacSystemFont, sans-serif';
                    const xPosition = currentX + tagPadding + 6 + textWidth + tagPadding;
                    ctx.fillText('√ó', xPosition, currentY + tagHeight / 2);
                    
                    // Store clickable area for X button
                    chart.customLegendAreas.push({
                        x: currentX,
                        y: currentY,
                        width: tagWidth,
                        height: tagHeight,
                        nutrientCode: nutrientCode
                    });
                    
                    // Update position for next tag
                    currentX += tagWidth + gapBetweenTags;
                    rowHeight = Math.max(rowHeight, tagHeight);
                });
            }
        };
        
        // ==================== DATA ====================
        const DATA = {
            stages: ['VE', 'V1', 'V2', 'V3', 'V4', 'R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'R7'],
            materials: {
                enlist: {
                    N: [5, 10, 15, 22, 30, 40, 52, 65, 75, 85, 92, 100],
                    P: [8, 15, 22, 30, 38, 48, 60, 72, 82, 90, 96, 100],
                    K: [6, 12, 18, 26, 35, 46, 58, 70, 80, 88, 94, 100],
                    Ca: [10, 18, 25, 32, 40, 50, 62, 72, 80, 88, 94, 100],
                    Mg: [8, 14, 20, 28, 36, 45, 56, 68, 78, 86, 93, 100],
                    S: [7, 13, 19, 27, 36, 47, 59, 71, 81, 89, 95, 100],
                    B: [6, 11, 17, 24, 33, 44, 56, 68, 78, 87, 93, 100],
                    Cu: [7, 12, 18, 25, 34, 45, 57, 69, 79, 88, 94, 100],
                    Fe: [9, 16, 23, 31, 39, 49, 61, 73, 83, 91, 96, 100],
                    Mn: [8, 14, 21, 29, 38, 48, 60, 72, 82, 90, 95, 100],
                    Zn: [7, 13, 19, 27, 36, 46, 58, 70, 80, 89, 95, 100],
                    Mo: [5, 9, 14, 20, 28, 38, 50, 63, 74, 84, 92, 100],
                    Co: [4, 8, 12, 18, 26, 36, 48, 61, 72, 83, 91, 100],
                    Ni: [5, 10, 15, 21, 29, 39, 51, 64, 75, 85, 93, 100]
                },
                xtend: {
                    N: [4, 9, 14, 20, 28, 38, 50, 63, 73, 83, 91, 100],
                    P: [7, 14, 21, 29, 37, 47, 59, 71, 81, 89, 95, 100],
                    K: [5, 11, 17, 25, 34, 45, 57, 69, 79, 87, 93, 100],
                    Ca: [9, 17, 24, 31, 39, 49, 61, 71, 79, 87, 93, 100],
                    Mg: [7, 13, 19, 27, 35, 44, 55, 67, 77, 85, 92, 100],
                    S: [6, 12, 18, 26, 35, 46, 58, 70, 80, 88, 94, 100],
                    B: [5, 10, 16, 23, 32, 43, 55, 67, 77, 86, 92, 100],
                    Cu: [6, 11, 17, 24, 33, 44, 56, 68, 78, 87, 93, 100],
                    Fe: [8, 15, 22, 30, 38, 48, 60, 72, 82, 90, 95, 100],
                    Mn: [7, 13, 20, 28, 37, 47, 59, 71, 81, 89, 94, 100],
                    Zn: [6, 12, 18, 26, 35, 45, 57, 69, 79, 88, 94, 100],
                    Mo: [4, 8, 13, 19, 27, 37, 49, 62, 73, 83, 91, 100],
                    Co: [3, 7, 11, 17, 25, 35, 47, 60, 71, 82, 90, 100],
                    Ni: [4, 9, 14, 20, 28, 38, 50, 63, 74, 84, 92, 100]
                },
                rr: {
                    N: [6, 11, 16, 23, 31, 41, 53, 66, 76, 86, 93, 100],
                    P: [9, 16, 23, 31, 39, 49, 61, 73, 83, 91, 97, 100],
                    K: [7, 13, 19, 27, 36, 47, 59, 71, 81, 89, 95, 100],
                    Ca: [11, 19, 26, 33, 41, 51, 63, 73, 81, 89, 95, 100],
                    Mg: [9, 15, 21, 29, 37, 46, 57, 69, 79, 87, 94, 100],
                    S: [8, 14, 20, 28, 37, 48, 60, 72, 82, 90, 96, 100],
                    B: [7, 12, 18, 25, 34, 45, 57, 69, 79, 88, 94, 100],
                    Cu: [8, 13, 19, 26, 35, 46, 58, 70, 80, 89, 95, 100],
                    Fe: [10, 17, 24, 32, 40, 50, 62, 74, 84, 92, 97, 100],
                    Mn: [9, 15, 22, 30, 39, 49, 61, 73, 83, 91, 96, 100],
                    Zn: [8, 14, 20, 28, 37, 47, 59, 71, 81, 90, 96, 100],
                    Mo: [6, 10, 15, 21, 29, 39, 51, 64, 75, 85, 93, 100],
                    Co: [5, 9, 13, 19, 27, 37, 49, 62, 73, 84, 92, 100],
                    Ni: [6, 11, 16, 22, 30, 40, 52, 65, 76, 86, 94, 100]
                }
            }
        };

        const NUTRIENTS = {
            N: { name: 'Nitrog√™nio (N)', color: '#007AFF' },
            P: { name: 'F√≥sforo (P)', color: '#FF9500' },
            K: { name: 'Pot√°ssio (K)', color: '#34C759' },
            Ca: { name: 'C√°lcio (Ca)', color: '#FF3B30' },
            Mg: { name: 'Magn√©sio (Mg)', color: '#AF52DE' },
            S: { name: 'Enxofre (S)', color: '#FFCC00' },
            B: { name: 'Boro (B)', color: '#5856D6' },
            Cu: { name: 'Cobre (Cu)', color: '#FF2D55' },
            Fe: { name: 'Ferro (Fe)', color: '#8E8E93' },
            Mn: { name: 'Mangan√™s (Mn)', color: '#30B0C7' },
            Zn: { name: 'Zinco (Zn)', color: '#32ADE6' },
            Mo: { name: 'Molibd√™nio (Mo)', color: '#BF5AF2' },
            Co: { name: 'Cobalto (Co)', color: '#FF6482' },
            Ni: { name: 'N√≠quel (Ni)', color: '#64D2FF' }
        };

        const MATERIALS = {
            enlist: { name: 'Enlist', color: '#34C759' },
            xtend: { name: 'Xtend', color: '#FF9500' },
            rr: { name: 'RR', color: '#FF3B30' }
        };

        // ==================== STATE ====================
        let chart = null;

        // ==================== SELECTORS ====================
        const nutrientTrigger = document.getElementById('nutrientTrigger');
        const nutrientDropdown = document.getElementById('nutrientDropdown');

        const materialTrigger = document.getElementById('materialTrigger');
        const materialDropdown = document.getElementById('materialDropdown');
        
        const chartTitle = document.getElementById('chartTitle');

        // ==================== DROPDOWN HANDLERS ====================
        function toggleDropdown(trigger, dropdown, otherTrigger, otherDropdown) {
            const isActive = trigger.classList.toggle('active');
            dropdown.classList.toggle('active');
            
            if (isActive) {
                otherTrigger.classList.remove('active');
                otherDropdown.classList.remove('active');
            }
        }

        nutrientTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(nutrientTrigger, nutrientDropdown, materialTrigger, materialDropdown);
        });

        materialTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown(materialTrigger, materialDropdown, nutrientTrigger, nutrientDropdown);
        });

        document.addEventListener('click', () => {
            nutrientTrigger.classList.remove('active');
            nutrientDropdown.classList.remove('active');
            materialTrigger.classList.remove('active');
            materialDropdown.classList.remove('active');
        });

        // ==================== EVENT LISTENERS ====================
        document.querySelectorAll('#nutrientDropdown input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateChart();
            });
        });

        document.querySelectorAll('#materialDropdown input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateChartTitle();
                updateChart();
                materialTrigger.classList.remove('active');
                materialDropdown.classList.remove('active');
            });
        });
        
        // Handle clicks on custom legend X buttons
        document.getElementById('chart').addEventListener('click', (e) => {
            if (!chart || !chart.customLegendAreas) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            chart.customLegendAreas.forEach(area => {
                // Check if click is within the tag area
                if (x >= area.x && x <= area.x + area.width &&
                    y >= area.y && y <= area.y + area.height) {
                    // Uncheck the nutrient
                    const checkbox = document.querySelector(`#nutrientDropdown input[value="${area.nutrientCode}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                        updateChart();
                    }
                }
            });
        });
        
        // Add cursor pointer when hovering over legend tags
        document.getElementById('chart').addEventListener('mousemove', (e) => {
            if (!chart || !chart.customLegendAreas) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            let isOverTag = false;
            chart.customLegendAreas.forEach(area => {
                if (x >= area.x && x <= area.x + area.width &&
                    y >= area.y && y <= area.y + area.height) {
                    isOverTag = true;
                }
            });
            
            e.target.style.cursor = isOverTag ? 'pointer' : 'default';
        });

        // ==================== CHART ====================
        function getSelectedNutrients() {
            return Array.from(document.querySelectorAll('#nutrientDropdown input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
        }

        function getSelectedMaterial() {
            const selected = document.querySelector('#materialDropdown input[type="radio"]:checked');
            return selected ? selected.value : 'enlist';
        }
        
        function updateChartTitle() {
            const material = getSelectedMaterial();
            chartTitle.textContent = `Curva de Absor√ß√£o - ${MATERIALS[material].name}`;
        }

        function updateChart() {
            const material = getSelectedMaterial();
            const nutrients = getSelectedNutrients();

            if (nutrients.length === 0) {
                if (chart) {
                    chart.data.datasets = [];
                    chart.update();
                }
                return;
            }

            const datasets = nutrients.map(nutrient => ({
                label: NUTRIENTS[nutrient].name,
                nutrientCode: nutrient,
                data: DATA.materials[material][nutrient],
                borderColor: NUTRIENTS[nutrient].color,
                backgroundColor: NUTRIENTS[nutrient].color + '15',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: NUTRIENTS[nutrient].color,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverBorderWidth: 3,
                fill: true
            }));

            if (chart) {
                chart.data.datasets = datasets;
                chart.customLegendAreas = [];
                chart.update('none');
            } else {
                initChart(datasets);
            }
        }

        function initChart(datasets) {
            const ctx = document.getElementById('chart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: DATA.stages,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.2,
                    layout: {
                        padding: {
                            top: 80,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 14,
                            cornerRadius: 12,
                            titleFont: {
                                size: 15,
                                weight: '600',
                                family: '-apple-system, BlinkMacSystemFont, sans-serif'
                            },
                            bodyFont: {
                                size: 14,
                                family: '-apple-system, BlinkMacSystemFont, sans-serif'
                            },
                            callbacks: {
                                label: (context) => {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 13,
                                    weight: '600',
                                    family: '-apple-system, BlinkMacSystemFont, sans-serif'
                                },
                                color: '#1d1d1f',
                                padding: 8
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.04)',
                                drawBorder: false
                            },
                            border: {
                                display: false,
                                dash: [5, 5]
                            },
                            ticks: {
                                font: {
                                    size: 13,
                                    family: '-apple-system, BlinkMacSystemFont, sans-serif'
                                },
                                color: '#86868b',
                                padding: 8,
                                callback: (value) => value + '%'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    }
                },
                plugins: [customLegendPlugin]
            });
        }

        // ==================== INIT ====================
        updateChartTitle();
        updateChart();
    </script>
</body>
</html>
